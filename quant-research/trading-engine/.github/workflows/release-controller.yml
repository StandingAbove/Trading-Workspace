name: Master Release Controller

on:
  workflow_dispatch:
    inputs:
      release_level:
        description: 'Release Level (Version Bump)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      deploy_prod_paper:
        description: 'Deploy Production Paper?'
        type: boolean
        default: false
      deploy_sim_paper:
        description: 'Deploy Simulations Paper?'
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  # ==================================================================
  # JOB 1: PRODUCTION PAPER
  # ==================================================================
  release-prod-paper:
    name: Release Prod Paper
    if: ${{ inputs.deploy_prod_paper == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Bump version
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ inputs.release_level }}
          tag_prefix: "prod-paper-v"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker auth
        run: gcloud auth configure-docker

      - name: Build Docker
        run: |
          PROJECT_ID="wsb-hc-qasap-ae2e"
          IMAGE="production-paper"
          TAG="${{ steps.tag.outputs.new_tag }}"
          docker buildx build --platform linux/amd64 -t gcr.io/$PROJECT_ID/$IMAGE:$TAG -t gcr.io/$PROJECT_ID/$IMAGE:latest -f src/production/paper/Dockerfile . --push

      - name: Deploy Cloud Run
        env:
          PROJECT_ID: wsb-hc-qasap-ae2e
          REGION: us-east4
          SERVICE_ACCOUNT: prod-job-runner@wsb-hc-qasap-ae2e.iam.gserviceaccount.com
          NEWRELIC_API_KEY: ${{ secrets.NEWRELIC_API_KEY }}
          IB_HOST: 10.4.0.2
          IB_PORT: 4004
          IMAGE: production-paper
          TAG: ${{ steps.tag.outputs.new_tag }}
        run: |
          deploy_job() { gcloud run jobs update "$1" --image "gcr.io/$PROJECT_ID/$2" --region "$REGION" --service-account "$SERVICE_ACCOUNT" --vpc-connector=run-conn-us-east4 --vpc-egress=private-ranges-only --max-retries 3 "${@:3}" || gcloud run jobs create "$1" --image "gcr.io/$PROJECT_ID/$2" --region "$REGION" --service-account "$SERVICE_ACCOUNT" --vpc-connector=run-conn-us-east4 --vpc-egress=private-ranges-only --max-retries 3 "${@:3}"; }
          deploy_scheduler() { gcloud scheduler jobs update http "$1" --location="$REGION" --schedule="$2" --time-zone="$4" --uri="https://$REGION-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/$PROJECT_ID/jobs/$3:run" --http-method=POST --oauth-service-account-email="$SERVICE_ACCOUNT" --oauth-token-scope="https://www.googleapis.com/auth/cloud-platform" || gcloud scheduler jobs create http "$1" --location="$REGION" --schedule="$2" --time-zone="$4" --uri="https://$REGION-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/$PROJECT_ID/jobs/$3:run" --http-method=POST --oauth-service-account-email="$SERVICE_ACCOUNT" --oauth-token-scope="https://www.googleapis.com/auth/cloud-platform"; }
          
          FULL_IMAGE="$IMAGE:$TAG"
          deploy_job "production-paper-job" "$FULL_IMAGE" --set-env-vars=environment=prod,variant=paper,NEWRELIC_API_KEY=$NEWRELIC_API_KEY,IB_HOST=$IB_HOST,IB_PORT=$IB_PORT,IB_CLIENT_ID=1
          deploy_scheduler production-paper-scheduler "40 14 * * 1-5" production-paper-job "America/Chicago"

      # -----------------------------------------------------------
      # NOTIFY TEAMS (PYTHON)
      # -----------------------------------------------------------
      - name: Notify Teams
        if: success()
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run Notification Script
        if: success()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          VERSION: ${{ steps.tag.outputs.new_tag }}
          ACTOR: ${{ github.actor }}
          PIPELINE: "Production Paper"
          REPO_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          pip install pymsteams
          python -c "
          import pymsteams
          import os
          import subprocess

          # Get commit message safely
          commit_msg = subprocess.getoutput('git log -1 --format=%s')

          # Initialize card
          myTeamsMessage = pymsteams.connectorcard(os.environ['TEAMS_WEBHOOK_URL'])
          
          # Build the message text
          msg = f'''
          ðŸš€ New Deployment  
          **Pipeline:** {os.environ['PIPELINE']}  
          **Version:** {os.environ['VERSION']}  
          **Commit:** {commit_msg}  
          **Executed by:** {os.environ['ACTOR']}
          '''
          myTeamsMessage.text(msg)
          myTeamsMessage.send()
          "

  # ==================================================================
  # JOB 2: SIMULATIONS PAPER
  # ==================================================================
  release-sim-paper:
    name: Release Sim Paper
    if: ${{ inputs.deploy_sim_paper == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Bump version
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ inputs.release_level }}
          tag_prefix: "sim-paper-v"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker auth
        run: gcloud auth configure-docker

      - name: Build Docker
        run: |
          PROJECT_ID="wsb-hc-qasap-ae2e"
          IMAGE="simulations-paper"
          TAG="${{ steps.tag.outputs.new_tag }}"
          docker buildx build --platform linux/amd64 -t gcr.io/$PROJECT_ID/$IMAGE:$TAG -t gcr.io/$PROJECT_ID/$IMAGE:latest -f src/production/simulations/Dockerfile . --push

      - name: Deploy Cloud Run
        env:
          PROJECT_ID: wsb-hc-qasap-ae2e
          REGION: us-east4
          SERVICE_ACCOUNT: prod-job-runner@wsb-hc-qasap-ae2e.iam.gserviceaccount.com
          NEWRELIC_API_KEY: ${{ secrets.NEWRELIC_API_KEY }}
          IMAGE: simulations-paper
          TAG: ${{ steps.tag.outputs.new_tag }}
        run: |
          deploy_job() { gcloud run jobs update "$1" --image "gcr.io/$PROJECT_ID/$2" --region "$REGION" --service-account "$SERVICE_ACCOUNT" --vpc-connector=run-conn-us-east4 --vpc-egress=private-ranges-only --max-retries 3 "${@:3}" || gcloud run jobs create "$1" --image "gcr.io/$PROJECT_ID/$2" --region "$REGION" --service-account "$SERVICE_ACCOUNT" --vpc-connector=run-conn-us-east4 --vpc-egress=private-ranges-only --max-retries 3 "${@:3}"; }
          deploy_scheduler() { gcloud scheduler jobs update http "$1" --location="$REGION" --schedule="$2" --time-zone="$4" --uri="https://$REGION-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/$PROJECT_ID/jobs/$3:run" --http-method=POST --oauth-service-account-email="$SERVICE_ACCOUNT" --oauth-token-scope="https://www.googleapis.com/auth/cloud-platform" || gcloud scheduler jobs create http "$1" --location="$REGION" --schedule="$2" --time-zone="$4" --uri="https://$REGION-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/$PROJECT_ID/jobs/$3:run" --http-method=POST --oauth-service-account-email="$SERVICE_ACCOUNT" --oauth-token-scope="https://www.googleapis.com/auth/cloud-platform"; }
          
          FULL_IMAGE="$IMAGE:$TAG"
          deploy_job "simulations-paper-job" "$FULL_IMAGE" --set-env-vars=environment=prod,variant=paper,NEWRELIC_API_KEY=$NEWRELIC_API_KEY --cpu=1 --memory=1Gi --tasks=1
          deploy_scheduler simulations-paper-scheduler "0 19 * * 1-5" simulations-paper-job "America/Chicago"

      # -----------------------------------------------------------
      # NOTIFY TEAMS (PYTHON)
      # -----------------------------------------------------------
      - name: Notify Teams
        if: success()
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run Notification Script
        if: success()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          VERSION: ${{ steps.tag.outputs.new_tag }}
          ACTOR: ${{ github.actor }}
          PIPELINE: "Simulations Paper"
          REPO_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          pip install pymsteams
          python -c "
          import pymsteams
          import os
          import subprocess

          commit_msg = subprocess.getoutput('git log -1 --format=%s')

          myTeamsMessage = pymsteams.connectorcard(os.environ['TEAMS_WEBHOOK_URL'])

          msg = f'''
          ðŸš€ New Deployment  
          **Pipeline:** {os.environ['PIPELINE']}  
          **Version:** {os.environ['VERSION']}  
          **Commit:** {commit_msg}  
          **Executed by:** {os.environ['ACTOR']}
          '''
          myTeamsMessage.text(msg)
          myTeamsMessage.send()
          "
